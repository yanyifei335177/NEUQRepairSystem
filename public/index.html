<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NEUQç”µå­è®¾å¤‡ç»´ä¿®</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background: #f5f5f5; }
    header { background: #004080; color: white; padding: 15px; text-align: center; font-size: 22px; font-weight: bold; }
    .container { max-width: 1000px; margin: 20px auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .hidden { display: none; }
    .btn { padding: 8px 12px; border: none; border-radius: 5px; cursor: pointer; }
    .btn-confirm { background: #4caf50; color: white; }
    .btn-reject { background: #f44336; color: white; }
    .btn-delete { background: #555; color: white; }
    .btn-add { background: #2196f3; color: white; margin-bottom: 10px; }
    .status-pending { color: red; font-weight: bold; }
    .status-confirmed { color: green; font-weight: bold; }
    .status-rejected { color: orange; font-weight: bold; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #eee; }
    input, select, textarea { width: 100%; padding: 6px; margin: 5px 0; }
    #chart { width: 100%; height: 300px; }
    #login, #adminPanel, #clientPanel { display: none; }
  </style>
</head>
<body>
  <header>NEUQç”µå­è®¾å¤‡ç»´ä¿®ç³»ç»Ÿ</header>

  <div class="container" id="login">
    <h2>ç®¡ç†å‘˜ç™»å½•</h2>
    <input id="adminUser" placeholder="è´¦å·" />
    <input id="adminPass" type="password" placeholder="å¯†ç " />
    <button class="btn btn-confirm" onclick="login()">ç™»å½•</button>
  </div>

  <div class="container" id="clientPanel">
    <h2>å®¢æˆ·ç”³è¯·ç»´ä¿®</h2>
    <div>
      <input id="name" placeholder="å§“å" />
      <input id="phone" placeholder="æ‰‹æœºå·ï¼ˆéšæœºå¯ï¼‰" />
      <input id="email" placeholder="QQé‚®ç®±" />
      <select id="service">
        <option value="ç”µè„‘æ¸…ç°">ç”µè„‘æ¸…ç°</option>
        <option value="æ‰‹æœºè´´è†œ">æ‰‹æœºè´´è†œ</option>
        <option value="å°ç”µå­è®¾å¤‡ç»´ä¿®">å°ç”µå­è®¾å¤‡ç»´ä¿®</option>
        <option value="å…¶ä»–">å…¶ä»–</option>
      </select>
      <textarea id="description" placeholder="é—®é¢˜æè¿°"></textarea>
      <!-- ğŸ“¸ æ­¤å¤„å¯åŠ ä¸Šä¼ ç…§ç‰‡æŒ‰é’® -->
      <input id="date" type="datetime-local" />
      <select id="location">
        <option value="å·¥å­¦é¦†">å·¥å­¦é¦†</option>
        <option value="é¹å››4331">é¹å››4331</option>
        <option value="æ ¡äº”5508">æ ¡äº”5508</option>
      </select>
      <button class="btn btn-add" onclick="submitRepair()">æäº¤ç”³è¯·</button>
    </div>

    <h3>ç”³è¯·è®°å½•</h3>
    <table id="clientTable">
      <thead>
        <tr>
          <th>ç¼–å·</th><th>æœåŠ¡ç±»å‹</th><th>æè¿°</th><th>é¢„çº¦æ—¶é—´</th>
          <th>åœ°ç‚¹</th><th>çŠ¶æ€</th><th>é©³å›åŸå› </th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <button class="btn" onclick="switchToAdmin()">åå°ç™»å½•</button>
  </div>

  <div class="container" id="adminPanel">
    <h2>åå°ç®¡ç†</h2>
    <button class="btn btn-add" onclick="loadRepairs()">åˆ·æ–°æ•°æ®</button>
    <button class="btn" onclick="showChart()">æŸ¥çœ‹ç»Ÿè®¡å›¾è¡¨</button>

    <h3>å¾…ç¡®è®¤ç”³è¯· <span id="pendingCount" style="color:red"></span></h3>
    <table id="pendingTable">
      <thead>
        <tr><th>ID</th><th>å§“å</th><th>æœåŠ¡</th><th>æè¿°</th><th>æ—¶é—´</th><th>æ“ä½œ</th></tr>
      </thead>
      <tbody></tbody>
    </table>

    <h3>å¾…ç»´ä¿®</h3>
    <table id="confirmedTable">
      <thead>
        <tr><th>ID</th><th>å§“å</th><th>æœåŠ¡</th><th>æè¿°</th><th>æ—¶é—´</th><th>æ“ä½œ</th></tr>
      </thead>
      <tbody></tbody>
    </table>

    <div id="chartContainer" class="hidden">
      <h3>å„ç±»ç»´ä¿®å·²å®Œæˆæ•°é‡ç»Ÿè®¡</h3>
      <canvas id="chart"></canvas>
    </div>

    <button class="btn" onclick="switchToClient()">è¿”å›å®¢æˆ·ç«¯</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const api = (url, method = "GET", data = null) => {
      return fetch(url, {
        method,
        headers: { "Content-Type": "application/json" },
        body: data ? JSON.stringify(data) : null
      }).then(r => r.json());
    };

    // åˆå§‹æ˜¾ç¤º
    document.getElementById("clientPanel").style.display = "block";

    async function submitRepair() {
      const data = {
        name: document.getElementById("name").value || "åŒ¿å",
        phone: document.getElementById("phone").value || "1" + Math.floor(3000000000 + Math.random() * 6000000000),
        email: document.getElementById("email").value || "test@qq.com",
        service: document.getElementById("service").value,
        description: document.getElementById("description").value,
        date: document.getElementById("date").value,
        location: document.getElementById("location").value
      };
      await api("/api/repairs", "POST", data);
      alert("æäº¤æˆåŠŸï¼");
      loadClientTable();
    }

    async function loadClientTable() {
      const res = await api("/api/repairs");
      const tbody = document.querySelector("#clientTable tbody");
      tbody.innerHTML = "";
      res.forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.id}</td>
          <td>${r.service}</td>
          <td>${r.description}</td>
          <td>${r.date}</td>
          <td>${r.location}</td>
          <td class="status-${r.status}">${r.status}</td>
          <td>${r.reason || ""}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    loadClientTable();

    // åå°ç™»å½•
    async function login() {
      const user = document.getElementById("adminUser").value;
      const pass = document.getElementById("adminPass").value;
      try {
        const res = await api("/api/admin/login", "POST", { user, pass });
        if (res.ok) {
          alert("ç™»å½•æˆåŠŸï¼");
          document.getElementById("login").style.display = "none";
          document.getElementById("clientPanel").style.display = "none";
          document.getElementById("adminPanel").style.display = "block";
          loadRepairs();
        }
      } catch {
        alert("è´¦å·æˆ–å¯†ç é”™è¯¯");
      }
    }

    async function loadRepairs() {
      const res = await api("/api/repairs");
      const pending = res.filter(r => r.status === "pending");
      const confirmed = res.filter(r => r.status === "confirmed");
      const pendingBody = document.querySelector("#pendingTable tbody");
      const confirmedBody = document.querySelector("#confirmedTable tbody");
      pendingBody.innerHTML = confirmedBody.innerHTML = "";

      document.getElementById("pendingCount").textContent = pending.length ? `(${pending.length}æ¡)` : "";

      pending.forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.id}</td><td>${r.name}</td><td>${r.service}</td><td>${r.description}</td><td>${r.date}</td>
          <td>
            <button class="btn btn-confirm" onclick="confirmRepair(${r.id})">ç¡®è®¤</button>
            <button class="btn btn-reject" onclick="rejectRepair(${r.id})">é©³å›</button>
          </td>`;
        pendingBody.appendChild(tr);
      });

      confirmed.forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.id}</td><td>${r.name}</td><td>${r.service}</td><td>${r.description}</td><td>${r.date}</td>
          <td>
            <button class="btn btn-delete" onclick="completeRepair(${r.id})">ç»´ä¿®å®Œæˆ(åˆ é™¤)</button>
          </td>`;
        confirmedBody.appendChild(tr);
      });
    }

    async function confirmRepair(id) {
      await api(`/api/repairs/${id}/confirm`, "POST");
      loadRepairs();
    }

    async function rejectRepair(id) {
      const reason = prompt("è¯·è¾“å…¥é©³å›åŸå› ï¼š");
      if (!reason) return;
      await api(`/api/repairs/${id}/reject`, "POST", { reason });
      loadRepairs();
    }

    async function completeRepair(id) {
      await api(`/api/repairs/${id}/complete`, "POST");
      await api(`/api/repairs/${id}`, "DELETE"); // åˆ é™¤æ•°æ®åº“è®°å½•
      loadRepairs();
      loadClientTable();
    }

    function switchToAdmin() {
      document.getElementById("clientPanel").style.display = "none";
      document.getElementById("login").style.display = "block";
    }

    function switchToClient() {
      document.getElementById("adminPanel").style.display = "none";
      document.getElementById("clientPanel").style.display = "block";
      loadClientTable();
    }

    async function showChart() {
      const res = await api("/api/repairs");
      const completed = res.filter(r => r.status === "completed");
      const data = { "ç”µè„‘æ¸…ç°": 0, "æ‰‹æœºè´´è†œ": 0, "å°ç”µå­è®¾å¤‡ç»´ä¿®": 0, "å…¶ä»–": 0 };
      completed.forEach(r => { if (data[r.service] !== undefined) data[r.service]++; });
      const ctx = document.getElementById("chart").getContext("2d");
      document.getElementById("chartContainer").classList.remove("hidden");
      new Chart(ctx, {
        type: "bar",
        data: {
          labels: Object.keys(data),
          datasets: [{
            label: "å·²å®Œæˆç»´ä¿®æ•°é‡",
            data: Object.values(data)
          }]
        }
      });
    }
  </script>
</body>
</html>
